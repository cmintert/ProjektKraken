============================= test session starts =============================
platform win32 -- Python 3.13.9, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\chris\Antigravity Projects\ProjektKraken\.venv\Scripts\python.exe
cachedir: .pytest_cache
PySide6 6.10.1 -- Qt runtime 6.10.1 -- Qt compiled 6.10.1
rootdir: C:\Users\chris\Antigravity Projects\ProjektKraken
configfile: pytest.ini
plugins: cov-7.0.0, qt-4.5.0
2025-12-11 19:05:11 - root - INFO - ============================================================
2025-12-11 19:05:11 - root - INFO - Project Kraken Session Started at 2025-12-11T19:05:11.624344
2025-12-11 19:05:11 - root - INFO - Debug Mode: True
2025-12-11 19:05:11 - root - INFO - ============================================================
collecting ... collected 15 items

tests/unit/test_main_window_ext.py::test_delete_event_success PASSED
tests/unit/test_main_window_ext.py::test_delete_event_sends_command PASSED
tests/unit/test_main_window_ext.py::test_update_event_success PASSED
tests/unit/test_main_window_ext.py::test_update_event_sends_command PASSED
tests/unit/test_main_window_ext.py::test_add_relation_success PASSED
tests/unit/test_main_window_ext.py::test_add_relation_bidirectional PASSED
tests/unit/test_main_window_ext.py::test_remove_relation_success PASSED
tests/unit/test_main_window_ext.py::test_remove_relation_no_current_event PASSED
tests/unit/test_main_window_ext.py::test_update_relation_success PASSED
tests/unit/test_main_window_ext.py::test_update_relation_no_current_event PASSED
tests/unit/test_main_window_ext.py::test_dock_options_set PASSED
tests/unit/test_main_window_ext.py::test_central_widget_is_hidden PASSED
tests/unit/test_main_window_ext.py::test_all_docks_are_floatable PASSED
tests/unit/test_main_window_ext.py::test_load_event_details_no_event PASSED
tests/unit/test_main_window_ext.py::test_wikilink_completion_refreshes_ui TEST: TestResultType=<class 'src.commands.base_command.CommandResult'>
TEST: MainResultType=<class 'src.commands.base_command.CommandResult'>
DEBUG: on_command_finished name=
TEST: Mock called: False
TEST: Current Event ID: evt1
FAILED

================================== FAILURES ===================================
____________________ test_wikilink_completion_refreshes_ui ____________________

main_window = <src.app.main.MainWindow(0x27c3f691670) at 0x0000027C3DE3E200>

    def test_wikilink_completion_refreshes_ui(main_window):
        """Test that WikiLink command completion triggers UI refresh."""
        from src.commands.base_command import CommandResult
        from unittest.mock import call
    
        # Setup active event in editor
        main_window.event_editor._current_event_id = "evt1"
    
        # Simulate WikiLink command completion
        result = CommandResult(True, "Created links", "ProcessWikiLinksCommand")
    
        # Patch load_event_details to verify it gets called
        # Patch load_event_details to verify it gets called
        with patch.object(main_window, "load_event_details") as mock_load:
    
            # Verify CommandResult type
            from src.app.main import CommandResult as MainCMD
    
            print(f"TEST: TestResultType={type(result)}")
            print(f"TEST: MainResultType={MainCMD}")
            assert isinstance(result, MainCMD)
    
            main_window.on_command_finished(result)
    
            print(f"TEST: Mock called: {mock_load.called}")
            if not mock_load.called:
                print(
                    f"TEST: Current Event ID: {main_window.event_editor._current_event_id}"
                )
    
            # Verify load_event_details was called with the correct ID
>           mock_load.assert_called_once_with("evt1")

tests\unit\test_main_window_ext.py:246: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock name='load_event_details' id='2732642844160'>
args = ('evt1',), kwargs = {}
msg = "Expected 'load_event_details' to be called once. Called 0 times."

    def assert_called_once_with(self, /, *args, **kwargs):
        """assert that the mock was called exactly once and that that call was
        with the specified arguments."""
        if not self.call_count == 1:
            msg = ("Expected '%s' to be called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'load_event_details' to be called once. Called 0 times.

C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.13_3.13.2544.0_x64__qbz5n2kfra8p0\Lib\unittest\mock.py:990: AssertionError
=========================== short test summary info ===========================
FAILED tests/unit/test_main_window_ext.py::test_wikilink_completion_refreshes_ui
======================== 1 failed, 14 passed in 0.35s =========================
